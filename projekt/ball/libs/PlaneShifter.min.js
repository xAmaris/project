// Build date: 2017-09-25T10:46:56

/*
* Author    Jonathan Lurie - http://me.jonahanlurie.fr
* License   MIT
* Link      https://github.com/jonathanlurie/PlaneShifter
* Lab       MCIN - http://mcin.ca/ - Montreal Neurological Institute
*/
var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,d,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[d]=c.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var d=0;return $jscomp.iteratorPrototype(function(){return d<a.length?{done:!1,value:a[d++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.array=$jscomp.array||{};$jscomp.iteratorFromArray=function(a,d){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,b={next:function(){if(c<a.length){var e=c++;return{value:d(e,a[e]),done:!1}}b.next=function(){return{done:!0,value:void 0}};return b.next()}};b[Symbol.iterator]=function(){return b};return b};
$jscomp.polyfill=function(a,d,c,b){if(d){c=$jscomp.global;a=a.split(".");for(b=0;b<a.length-1;b++){var e=a[b];e in c||(c[e]={});c=c[e]}a=a[a.length-1];b=c[a];d=d(b);d!=b&&null!=d&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:d})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6-impl","es3");
$jscomp.polyfill("Math.sign",function(a){return a?a:function(a){a=Number(a);return 0===a||isNaN(a)?a:0<a?1:-1}},"es6-impl","es3");
(function(a,d){"object"===typeof exports&&"undefined"!==typeof module?d(exports):"function"===typeof define&&define.amd?define(["exports"],d):d(a.PlaneShifter=a.PlaneShifter||{})})(this,function(a){var d=null,c=function(b,a,c){c=void 0===c?{}:c;this._requireThree();this._enabled=!0;this._planeContainer=b;this._camera=a;this._controls=this._getOption(c,"controls",null);this._mouse=this._getOption(c,"mouse",new d.Vector2(Infinity,Infinity));this._useReferenceMouse=!!c.mouse;this._pointClicked2D=this._pointClicked3D=
null;this._raycaster=new d.Raycaster;this._cameraFollowObject=!1;this._keyPressed={};this._originalDistanceToCam=this._camera.position.clone().sub(this._planeContainer.position).length();this._boundingBox=new d.Box3(new d.Vector3(-Infinity,-Infinity,-Infinity),new d.Vector3(Infinity,Infinity,Infinity));this._rotateConfig={};this._shiftConfig={};this._states={IDLE:0,TRANSLATION:1,ROTATION:2};this._activeState=this._states.IDLE;b=this._getOption(c,"rotationKey","KeyR");c=this._getOption(c,"rotationKey",
"KeyT");this._keysStates={};this._keysStates[b]=this._states.ROTATION;this._keysStates[c]=this._states.TRANSLATION;this._initNormals();this._initEvents();this._customEvents={startInteraction:[],stopInteraction:[],rotation:[],translation:[]}};c.prototype._requireThree=function(){try{d=window&&window.THREE||require("three")}catch(b){try{d=require("three")}catch(e){console.error(e)}}};c.prototype._getOption=function(b,a,c){return b?b[a]||c:c};c.prototype.setBoundingBox=function(b){this._boundingBox=
b.clone()};c.prototype._initNormals=function(){this._planeContainer.children.forEach(function(b){b.userData.normalV=(new d.Vector3(0,0,1)).applyQuaternion(b.quaternion).normalize()})};c.prototype._initEvents=function(){window.addEventListener("mousemove",this._onMouseMove.bind(this),!1);window.addEventListener("mousedown",this._onMouseDown.bind(this),!1);window.addEventListener("mouseup",this._onMouseUp.bind(this),!1);window.addEventListener("keyup",this._onKeyUp.bind(this),!1);window.addEventListener("keydown",
this._onKeyDown.bind(this),!1)};c.prototype._onMouseMove=function(b){this._enabled&&(this._useReferenceMouse||(this._mouse.x=b.clientX/window.innerWidth*2-1,this._mouse.y=2*-(b.clientY/window.innerHeight)+1),this._followInteraction())};c.prototype._onMouseDown=function(b){this._enabled&&(this._keyPressed.mouse=!0,this._activeState!=this._states.IDLE&&this._raycast())};c.prototype._onMouseUp=function(b){this._enabled&&(this._interacting=this._keyPressed.mouse=!1)};c.prototype._isKeyPressed=function(b){return b in
this._keyPressed&&this._keyPressed[b]};c.prototype._onKeyUp=function(b){this._enabled&&(this._keyPressed[b.code]=!1,this._evaluateCurentState())};c.prototype._onKeyDown=function(b){this._enabled&&(this._keyPressed[b.code]=!0,this._evaluateCurentState())};c.prototype._evaluateCurentState=function(){var b=this._activeState;this._activeState=this._states.IDLE;for(var a=Object.keys(this._keysStates),c=0;c<a.length;c++)if(a[c]in this._keyPressed&&this._keyPressed[a[c]]){this._activeState=this._keysStates[a[c]];
break}b!=this._activeState&&(this._activeState==this._states.IDLE?(this._enableControl(),this._triggerEvents("stopInteraction")):(this._disableControl(),this._triggerEvents("startInteraction")))};c.prototype.setCameraFollowObject=function(b){this._cameraFollowObject=b};c.prototype._getScreenCoord=function(b){b=b.clone();b.project(this._camera);return new d.Vector2(b.x,b.y)};c.prototype._raycast=function(){this._raycaster.setFromCamera(this._mouse,this._camera);for(var b=this._raycaster.intersectObject(this._planeContainer,
!0),a=0;a<b.length;a++)if(this._boundingBox.containsPoint(b[a].point)){switch(this._activeState){case this._states.TRANSLATION:this._castedRayForTranslation(b[a]);break;case this._states.ROTATION:this._castedRayForRotation(b[a])}break}};c.prototype._castedRayForTranslation=function(b){this._interacting=!0;var a=b.object;this._shiftConfig.originalObjectPosition=this._planeContainer.position.clone();this._shiftConfig.hitPoint3D=b.point.clone();this._shiftConfig.hitPoint2D=this._mouse.clone();this._shiftConfig.planeNormalInternal3D=
a.userData.normalV.clone();this._shiftConfig.planeNormalWorld3D=a.userData.normalV.clone().applyQuaternion(this._planeContainer.quaternion).normalize();this._shiftConfig.topPoint3D=this._shiftConfig.hitPoint3D.clone().add(this._shiftConfig.planeNormalWorld3D);this._shiftConfig.topPoint2D=this._getScreenCoord(this._shiftConfig.topPoint3D);this._shiftConfig.planeNormal2D=new d.Vector2(this._shiftConfig.topPoint2D.x-this._shiftConfig.hitPoint2D.x,this._shiftConfig.topPoint2D.y-this._shiftConfig.hitPoint2D.y);
this._shiftConfig.hitPoint3DInternal=this._planeContainer.worldToLocal(b.point.clone())};c.prototype._followInteraction=function(){if(this._interacting)switch(this._activeState){case this._states.TRANSLATION:this._followTranslation();break;case this._states.ROTATION:this._followRotation()}};c.prototype._followTranslation=function(){var b=new d.Vector2(this._mouse.x-this._shiftConfig.hitPoint2D.x,this._mouse.y-this._shiftConfig.hitPoint2D.y);this._camera.position.clone().sub(this._planeContainer.position).length();
var a=this._shiftConfig.planeNormal2D.length(),b=b.dot(this._shiftConfig.planeNormal2D.clone().normalize())/a,b=this._shiftConfig.planeNormalWorld3D.clone().multiplyScalar(b),a=new d.Vector3(this._shiftConfig.originalObjectPosition.x+b.x,this._shiftConfig.originalObjectPosition.y+b.y,this._shiftConfig.originalObjectPosition.z+b.z);this._boundingBox.containsPoint(a)&&(this._planeContainer.position.set(this._shiftConfig.originalObjectPosition.x+b.x,this._shiftConfig.originalObjectPosition.y+b.y,this._shiftConfig.originalObjectPosition.z+
b.z),this._triggerEvents("translation"));this._cameraFollowObject&&this._camera.lookAt(this._planeContainer.position)};c.prototype._disableControl=function(){this._controls&&(this._controls.enabled&&this._saveOrbitData(),this._controls.enabled=!1)};c.prototype._enableControl=function(){this._controls&&!this._controls.enabled&&(this._controls.enabled=!0,this._restoreOrbitData())};c.prototype._saveOrbitData=function(){this._orbitData={target:new d.Vector3,position:new d.Vector3,zoom:this._controls.object.zoom};
this._orbitData.target.copy(this._controls.target);this._orbitData.position.copy(this._controls.object.position)};c.prototype._restoreOrbitData=function(){this._controls.position0.copy(this._orbitData.position);this._cameraFollowObject?this._controls.target0.copy(this._planeContainer.position):this._controls.target0.copy(this._orbitData.target);this._controls.zoom0=this._orbitData.zoom;this._controls.reset()};c.prototype._castedRayForRotation=function(b){this._interacting=!0;b=b.object;this._rotateConfig.originalObjectRotation=
this._planeContainer.rotation.clone();this._rotateConfig.hitPoint2D=this._mouse.clone();this._rotateConfig.planeNormalInternal3D=b.userData.normalV.clone();this._rotateConfig.planeNormalWorld3D=b.userData.normalV.clone().applyQuaternion(this._planeContainer.quaternion).normalize();this._rotateConfig.center3D=this._planeContainer.getWorldPosition();this._rotateConfig.center2D=this._getScreenCoord(this._rotateConfig.center3D);this._rotateConfig.cameraObjectVector=(new d.Vector3(this._camera.position.x-
this._rotateConfig.center3D.x,this._camera.position.y-this._rotateConfig.center3D.y,this._camera.position.z-this._rotateConfig.center3D.z)).normalize();this._rotateConfig.cameraSign=Math.sign(this._rotateConfig.planeNormalWorld3D.dot(this._rotateConfig.cameraObjectVector))};c.prototype._followRotation=function(){var b=this._rotateConfig.center2D,a=this._rotateConfig.hitPoint2D,c=this._mouse.clone(),a=(new d.Vector3(a.x-b.x,a.y-b.y,a.z-b.z)).normalize(),c=(new d.Vector3(c.x-b.x,c.y-b.y,c.z-b.z)).normalize(),
b=Math.acos(a.dot(c)),a=Math.sign(a.cross(c).z);this._planeContainer.rotation.set(this._rotateConfig.originalObjectRotation.x,this._rotateConfig.originalObjectRotation.y,this._rotateConfig.originalObjectRotation.z);this._planeContainer.rotateOnAxis(this._rotateConfig.planeNormalInternal3D,b*a*this._rotateConfig.cameraSign);this._triggerEvents("rotation")};c.prototype.enable=function(b){this._enabled=b};c.prototype.on=function(b,a){"function"===typeof a&&b in this._customEvents&&this._customEvents[b].push(a)};
c.prototype._triggerEvents=function(b){if(b in this._customEvents){b=this._customEvents[b];for(var a=0;a<b.length;a++)b[a]()}};a.PlaneShifter=c;Object.defineProperty(a,"__esModule",{value:!0})});
